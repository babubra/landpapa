# –ö–æ–Ω—Ç–µ–∫—Å—Ç –º–∏–≥—Ä–∞—Ü–∏–∏ –ª–æ–∫–∞—Ü–∏–π –∏ –ü–ª–∞–Ω —á–∏—Å—Ç–∫–∏ –∫–æ–¥–∞

> **–°—Ç–∞—Ç—É—Å:** ‚úÖ –≠—Ç–∞–ø "–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö" –∑–∞–≤–µ—Ä—à–µ–Ω. üöß –≠—Ç–∞–ø "–ß–∏—Å—Ç–∫–∞ –∫–æ–¥–∞" –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è.
> **–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 03.02.2026

## 1. –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### ‚úÖ –°–¥–µ–ª–∞–Ω–æ (–ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)
1. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (`locations`)**:
   - –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ –∏ –∑–∞—Å–µ–ª–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏.
   - –ò–µ—Ä–∞—Ä—Ö–∏—è: –†–µ–≥–∏–æ–Ω -> –†–∞–π–æ–Ω—ã/–ì–æ—Ä–æ–¥–∞ -> –ü–æ—Å–µ–ª–∫–∏.
   - **Slugs**: –ü—Ä–∏–≤–µ–¥–µ–Ω—ã –∫ –ª–µ–≥–∞—Å–∏-–≤–∏–¥—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, `gur-evskij-r-n` —Å–æ—Ö—Ä–∞–Ω–µ–Ω).
   - **–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å–ª—É—á–∞–∏**: –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥, –ü–∏–æ–Ω–µ—Ä—Å–∫–∏–π, –Ø–Ω—Ç–∞—Ä–Ω—ã–π, –ü–æ–∫—Ä–æ–≤—Å–∫–æ–µ/–°–∏–Ω—è–≤–∏–Ω–æ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å–æ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–π –ª–æ–≥–∏–∫–æ–π.

2. **–û–±—ä—è–≤–ª–µ–Ω–∏—è (`listings`)**:
   - –ü–æ–ª–µ `location_id` –¥–æ–±–∞–≤–ª–µ–Ω–æ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –¥–ª—è –≤—Å–µ—Ö 1500+ –æ–±—ä—è–≤–ª–µ–Ω–∏–π.
   - –°–≤—è–∑—å —Å —Ç–∞–±–ª–∏—Ü–µ–π `locations` —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.

3. **–°–∫—Ä–∏–ø—Ç—ã**:
   - `migrate_full.py`: –†–∞–±–æ—á–∏–π, –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏.
   - `seed.py`: –û–±–Ω–æ–≤–ª–µ–Ω, –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ slugs –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–π.
   - `MIGRATION_INSTRUCTIONS.md`: –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é —Å–æ–∑–¥–∞–Ω–∞.

4. **Frontend (–§–∏–ª—å—Ç—Ä—ã)**:
   - –í—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã –ø–µ—Ä–µ–≤–µ–¥–µ–Ω—ã –Ω–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `SmartLocationFilter`.
   - –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ API `/api/locations/search`.
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω –±–∞–≥ —Å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º (ID 2: –ö–∞–ª–∏–Ω–∏–Ω–≥—Ä–∞–¥ vs –ë–∞–≥—Ä–∞—Ç–∏–æ–Ω–æ–≤—Å–∫–∏–π).

### ‚ö†Ô∏è –í –ø—Ä–æ—Ü–µ—Å—Å–µ (–†–µ–∂–∏–º —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
- **Backend API**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –∏ `location_id`, –∏ `settlement_id`/`district_id`.
- **Frontend Logic**: –°–æ–¥–µ—Ä–∂–∏—Ç –º–Ω–æ–≥–æ `fallback` –∫–æ–¥–∞ (–µ—Å–ª–∏ –Ω–µ—Ç location_id, –±–µ—Ä–µ–º settlement_id).
- **Admin**: –ß–∞—Å—Ç–∏—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ç–∞—Ä—ã–µ —Ä—É—á–∫–∏.

---

## 2. –ö–ª—é—á–µ–≤—ã–µ —Ä–µ—Å—É—Ä—Å—ã

| –†–µ—Å—É—Ä—Å | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|--------|------|----------|
| **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –¥–µ–ø–ª–æ—é** | `todo/MIGRATION_INSTRUCTIONS.md` | –ö–∞–∫ –Ω–∞–∫–∞—Ç–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥ |
| **–°–∫—Ä–∏–ø—Ç –º–∏–≥—Ä–∞—Ü–∏–∏** | `backend/app/scripts/migrate_full.py` | –ü–µ—Ä–µ–Ω–æ—Å –¥–∞–Ω–Ω—ã—Ö (SQL) |
| **–ù–æ–≤—ã–π —Ñ–∏–ª—å—Ç—Ä** | `components/filters/SmartLocationFilter.tsx` | –û—Å–Ω–æ–≤–Ω–æ–π UI –∫–æ–º–ø–æ–Ω–µ–Ω—Ç |
| **–¢–∏–ø—ã (Frontend)** | `kaliningrad-land/src/lib/geoUrl.ts` | –õ–æ–≥–∏–∫–∞ URL –∏ —Ç–∏–ø–æ–≤ |

---

## 3. –ü–ª–∞–Ω —á–∏—Å—Ç–∫–∏ –∫–æ–¥–∞ (Cleanup Plan)

–ù–∞—à–∞ —Ü–µ–ª—å ‚Äî —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥, —á—Ç–æ–±—ã —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–ª–∞ **—Ç–æ–ª—å–∫–æ** –Ω–∞ `location_id`.

### üßπ –≠—Ç–∞–ø 1: Backend Cleanup (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π)

–ó–∞–¥–∞—á–∏ –ø–æ —É–¥–∞–ª–µ–Ω–∏—é –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `district_id` –∏ `settlement_id` –∏–∑ API.

1. **`backend/app/models/listing.py`**:
   - –£–¥–∞–ª–∏—Ç—å `settlement_id`, `settlement`, `district` –∏–∑ –º–æ–¥–µ–ª–∏.
   - –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ `location` –∏ `location_id` ‚Äî –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–ª—è –≥–µ–æ.

2. **`backend/app/routers/listings.py` & `public_plots.py`**:
   - –£–¥–∞–ª–∏—Ç—å –≤—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã `district_id`, `settlement_id`.
   - –£–±—Ä–∞—Ç—å –ª–æ–≥–∏–∫—É —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ `Settlement` –∏ `District`.
   - –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Ñ–∏–ª—å—Ç—Ä `if location_id: ...`.

3. **`backend/app/schemas/`**:
   - –û—á–∏—Å—Ç–∏—Ç—å Pydantic –º–æ–¥–µ–ª–∏ (`ListingBase`, `ListingCreate`, `ListingUpdate`) –æ—Ç —Å—Ç–∞—Ä—ã—Ö –ø–æ–ª–µ–π.

4. **`backend/app/models/`**:
   - –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã `district.py` –∏ `settlement.py`.
   - –£–¥–∞–ª–∏—Ç—å –∏—Ö –∏–º–ø–æ—Ä—Ç—ã –∏–∑ `__init__.py` –∏ `seed.py`.

### üßπ –≠—Ç–∞–ø 2: Frontend Cleanup (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π)

–£–¥–∞–ª–µ–Ω–∏–µ fallback-–ª–æ–≥–∏–∫–∏ –∏ —Å—Ç–∞—Ä—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.

1. **`src/app/catalog/CatalogContent.tsx`**:
   - –£–±—Ä–∞—Ç—å —á—Ç–µ–Ω–∏–µ `district_id`, `settlement_id`, `settlements` –∏–∑ URL.
   - –£–±—Ä–∞—Ç—å –ª–æ–≥–∏–∫—É "–µ—Å–ª–∏ –Ω–µ—Ç locationId, –ø–æ–ø—Ä–æ–±—É–π settlementId".

2. **`src/app/[...geo]/page.tsx`**:
   - –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–π `resolveLocation` (–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ `resolveLocationNew`).
   - –£–±—Ä–∞—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é `geoLocation.settlementId` –∏ `districtId` (–æ—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Ç–∏–ø–æ–≤, –µ—Å–ª–∏ —Å–ª–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å—Ä–∞–∑—É, –Ω–æ –æ–±–Ω—É–ª–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ).

3. **`src/lib/geoUrl.ts`**:
   - –£–¥–∞–ª–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏, —Å—Ç—Ä–æ—è—â–∏–µ URL —Å query-params (`?settlements=`).
   - –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ Geo-URL (`/slug/slug`).

4. **–£–¥–∞–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤**:
   - `src/components/filters/LocationFilter.tsx` ‚ùå
   - `src/components/filters/HierarchyLocationFilter.tsx` ‚ùå

### üßπ –≠—Ç–∞–ø 3: Database Cleanup (–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ù–∏–∑–∫–∏–π)

–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∫–æ–¥ –ø—Ä–æ—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ø—Ä–æ–¥–µ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.

1. **Drop Tables**:
   - `DROP TABLE settlements CASCADE;`
   - `DROP TABLE districts CASCADE;`
2. **Drop Columns**:
   - –£–¥–∞–ª–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É `settlement_id` –∏–∑ —Ç–∞–±–ª–∏—Ü—ã `listings`.

---

## 4. –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è —Å—Ç–∞—Ä—Ç–∞
–ï—Å–ª–∏ –≤—ã –≥–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å —á–∏—Å—Ç–∫—É, –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ **–≠—Ç–∞–ø—É 1: Backend Cleanup**.
–†–µ–∫–æ–º–µ–Ω–¥—É—é –Ω–∞—á–∞—Ç—å —Å —É–¥–∞–ª–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–∑ `routers/listings.py`.
